# オーラルヒストリー文字起こし支援ツール - 技術ガイド

## 目次
1. [使用ライブラリの説明](#使用ライブラリの説明)
2. [音声同期機能の動作原理](#音声同期機能の動作原理)
3. [文字起こし機能について](#文字起こし機能について)
4. [システムアーキテクチャ](#システムアーキテクチャ)

## 使用ライブラリの説明

### WaveSurfer.js
**用途**: 音声波形の視覚化と再生位置の表示

WaveSurfer.jsは、Web Audio APIとCanvas/SVGを使用して音声波形を描画するJavaScriptライブラリです。

**主な機能**:
- 音声ファイルの波形を自動生成・表示
- 再生位置のリアルタイム表示
- ズーム・スクロール対応
- カスタマイズ可能な色設定

**実装のポイント**:
```javascript
const wavesurfer = WaveSurfer.create({
  container: container,
  waveColor: '#4CAF50',      // 波形の色
  progressColor: '#2196F3',   // 再生済み部分の色
  cursorColor: '#FF5722',     // 現在位置カーソルの色
  minPxPerSec: 100,          // 1秒=100px（0.01秒精度）
  scrollParent: true         // 横スクロール有効化
});
```

### Web Audio API
**用途**: 音声の再生制御と解析

標準のHTML5 Audio要素を拡張し、より高度な音声処理を実現します。

**主な利用箇所**:
- 複数音声ファイルの同期再生
- 音量・再生速度の個別制御
- ミュート機能の実装

### Dexie.js
**用途**: IndexedDBを使用したブラウザ内データ永続化

Dexie.jsは、IndexedDBのラッパーライブラリで、よりシンプルなAPIでデータの保存・取得が可能です。

**保存データ**:
- プロジェクト情報
- 音声ファイル（ArrayBuffer形式）
- 文字起こしデータ
- 同期設定

## 音声同期機能の動作原理

### 相互相関法による自動同期

本ツールでは、タイムスタンプベースの同期ではなく、**音声波形の相互相関解析**による自動同期を実装しています。

#### 動作原理

1. **音声データのサンプリング**
   - 各音声ファイルをWeb Audio APIでデコード
   - 44.1kHzまたは48kHzのサンプリングレートで取得

2. **相互相関の計算**
   ```javascript
   // 簡略化したアルゴリズム
   for (let offset = -maxOffset; offset <= maxOffset; offset += step) {
     let correlation = 0;
     for (let i = 0; i < overlapLength; i++) {
       correlation += reference[i] * target[i + offset];
     }
     // 最大相関値を持つオフセットを記録
   }
   ```

3. **最適オフセットの決定**
   - 相関値が最大となる時間差を検出
   - この時間差が音声ファイル間のオフセット値

#### メリット
- 録音開始タイミングのずれを自動補正
- 同じ音源を複数デバイスで録音した場合の高精度同期
- 手動調整の手間を大幅削減

#### 精度
- 0.01秒（10ミリ秒）単位での調整が可能
- 相関係数による信頼度表示

## 文字起こし機能について

### 現在の実装状況

#### セグメントベースのUI設計
現在の文字起こしUIは、一般的なテキストボックス方式ではなく、**セグメント（区間）ベース**の設計を採用しています。

**設計思想**:
1. **時間軸との連動**
   - 各セグメントに開始・終了時刻を設定
   - 音声再生と文字起こしの同期表示

2. **話者の明確化**
   - セグメントごとに話者を設定可能
   - インタビュー形式の会話を構造化

3. **段階的な編集**
   - 大まかな区切りから詳細な編集へ
   - 後から分割・結合が可能

**UI操作フロー**:
```
1. 音声を聞きながら話者交代点でセグメント作成
2. 各セグメントに話者を割り当て
3. セグメント内のテキストを編集
4. 必要に応じてセグメントを分割・結合
```

### Speech-to-Text APIの利用（将来実装）

#### 推奨API
1. **Google Cloud Speech-to-Text API**
   - 高精度な日本語認識
   - リアルタイム/バッチ処理対応

2. **Azure Speech Services**
   - Microsoft提供の音声認識サービス
   - 話者識別機能あり

3. **OpenAI Whisper API**
   - 多言語対応
   - ローカル実行も可能

#### APIキーの取得方法

**Google Cloud Speech-to-Text**の場合：
1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新規プロジェクトを作成
3. Speech-to-Text APIを有効化
4. 認証情報からAPIキーを作成
5. 本ツールの設定画面にAPIキーを入力

### 手動文字起こしの効率化機能

**実装済み/予定の機能**:
- キーボードショートカットによる再生制御
- 再生速度の調整（0.5x〜2.0x）
- 自動一時停止（一定時間ごと）
- フットペダル対応（将来実装）

## システムアーキテクチャ

### フロントエンド構成
```
Vue 3 (Composition API)
├── Components
│   ├── AudioManager.vue    # 音声管理・同期
│   ├── TranscriptEditor.vue # 文字起こし編集
│   └── ProjectList.vue     # プロジェクト一覧
├── Utils
│   ├── audioSync.ts        # 音声同期アルゴリズム
│   └── storage.ts          # データ永続化
└── Types
    └── index.ts            # TypeScript型定義
```

### データフロー
```
音声ファイル入力
    ↓
Web Audio APIでデコード
    ↓
相互相関解析（自動同期）
    ↓
WaveSurfer.jsで波形表示
    ↓
同期再生 + 文字起こし
    ↓
IndexedDBに保存
```

### ブラウザ要件
- Chrome 90+ / Firefox 88+ / Safari 14+
- Web Audio API対応
- IndexedDB対応（最低100MB以上の空き容量推奨）

## トラブルシューティング

### よくある問題と解決方法

**Q: 音声が再生されない**
- ブラウザの自動再生ポリシーを確認
- 音量設定・ミュート状態を確認

**Q: 波形が表示されない**
- MP3形式であることを確認
- ファイルサイズが大きすぎないか確認（推奨: 100MB以下）

**Q: 自動同期が機能しない**
- 同じ音源を録音したファイルか確認
- 録音品質が極端に異なっていないか確認

## 今後の開発予定

1. **Speech-to-Text統合**
   - 複数APIプロバイダー対応
   - バッチ処理による一括変換

2. **エクスポート機能**
   - SRT/VTT字幕形式
   - Word/PDF文書形式
   - タイムコード付きCSV

3. **コラボレーション機能**
   - 複数人での同時編集
   - コメント・レビュー機能

4. **高度な音声処理**
   - ノイズ除去
   - 音声強調
   - 話者自動識別

---

技術的な質問や提案は、[GitHubのIssue](https://github.com/code4history/oral-history-tool/issues)にてお願いします。